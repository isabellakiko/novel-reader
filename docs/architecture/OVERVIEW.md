# 架构总览

> Novel Reader 系统架构设计

**最后更新**: 2025-12-02

---

## 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                     Novel Reader                             │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │                    apps/web (React)                     │ │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐             │ │
│  │  │ Bookshelf│  │  Reader  │  │  Search  │    Pages    │ │
│  │  └──────────┘  └──────────┘  └──────────┘             │ │
│  │        │              │             │                  │ │
│  │  ┌─────┴──────────────┴─────────────┴─────┐           │ │
│  │  │           Zustand (State)              │           │ │
│  │  └────────────────────────────────────────┘           │ │
│  │        │                          │                    │ │
│  │  ┌─────┴──────┐           ┌──────┴──────┐             │ │
│  │  │   Dexie    │           │ Web Worker  │             │ │
│  │  │ (IndexedDB)│           │  (Search)   │             │ │
│  │  └────────────┘           └─────────────┘             │ │
│  └────────────────────────────────────────────────────────┘ │
│                              │                               │
│  ┌───────────────────────────┴────────────────────────────┐ │
│  │                  packages/core                          │ │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐             │ │
│  │  │  Parser  │  │  Search  │  │  Types   │   Modules   │ │
│  │  └──────────┘  └──────────┘  └──────────┘             │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                  packages/shared                         │ │
│  │  ┌──────────┐  ┌──────────┐                             │ │
│  │  │Constants │  │  Utils   │                             │ │
│  │  └──────────┘  └──────────┘                             │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 核心设计决策

### 1. 纯前端架构

**决策**: 当前阶段不使用后端服务器

**理由**:
- 99% 小说文件 < 50MB，浏览器完全能处理
- IndexedDB 可存储大量本地数据
- Web Worker 避免 UI 阻塞
- 无需服务器部署，用户体验更好

**预留**:
- `apps/server` 目录预留后端扩展
- 核心逻辑在 `packages/core`，可共享给后端

### 2. Monorepo 结构

**决策**: 使用 pnpm workspace

**理由**:
- 统一管理前端和核心逻辑
- 代码复用方便
- 便于后续扩展后端

### 3. 状态管理分层

| 数据类型 | 存储方案 | 示例 |
|----------|----------|------|
| UI 状态 | React useState | 弹窗开关 |
| 应用状态 | Zustand | 主题、字体设置 |
| 持久化数据 | Dexie (IndexedDB) | 书籍、进度 |

### 4. 大文件处理

**策略**:
- 文件解析：流式读取 + 编码转换
- 文本渲染：虚拟滚动
- 搜索：Web Worker 后台处理

---

## 数据流

```
用户导入文件
     │
     ▼
┌─────────────┐
│ File Reader │  读取文件为 ArrayBuffer
└─────────────┘
     │
     ▼
┌─────────────┐
│   Parser    │  编码检测 + 章节识别
│ (core)      │
└─────────────┘
     │
     ▼
┌─────────────┐
│   Dexie     │  存储书籍数据
│ (IndexedDB) │
└─────────────┘
     │
     ▼
┌─────────────┐
│   Zustand   │  状态管理
│  (Store)    │
└─────────────┘
     │
     ▼
┌─────────────┐
│    React    │  UI 渲染
│ Components  │
└─────────────┘
```

---

## 搜索架构

```
用户输入关键词
     │
     ▼
┌─────────────┐
│ SearchInput │  防抖处理
└─────────────┘
     │
     ▼
┌─────────────┐
│ Main Thread │  发送消息到 Worker
└─────────────┘
     │
     ▼
┌─────────────┐
│ Web Worker  │  执行搜索（不阻塞 UI）
│ (Search)    │
└─────────────┘
     │
     ▼
┌─────────────┐
│ SearchResult│  按章节分组结果
└─────────────┘
     │
     ▼
┌─────────────┐
│    React    │  渲染结果列表
│ Components  │
└─────────────┘
```

---

## 模块依赖

```
apps/web
    ├── packages/core
    │   └── packages/shared
    └── packages/shared
```

---

## 技术选型理由

| 技术 | 选择 | 理由 |
|------|------|------|
| 框架 | React 18 | 生态成熟，开发效率高 |
| 构建 | Vite | 开发体验好，热更新快 |
| 样式 | Tailwind CSS v3 | 快速开发，一致性好 |
| 动画 | Framer Motion | React 动画首选 |
| UI 组件 | Radix UI | 无样式可定制，可访问性好 |
| 状态 | Zustand | 轻量简单，TypeScript 友好 |
| 存储 | Dexie | IndexedDB 最佳封装 |

---

## 相关文档

- [技术栈详情](./tech-stack.md)
- [ADR 索引](./adr/README.md)
