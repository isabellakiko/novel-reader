# 架构总览

> Novel Reader 系统架构设计

**最后更新**: 2025-12-05

---

## 系统架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                         Novel Reader                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │                      apps/web (React)                           │ │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐       │ │
│  │  │ Library  │  │  Reader  │  │  Search  │  │ Bookmarks│ Pages │ │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘       │ │
│  │        │              │             │            │             │ │
│  │  ┌─────┴──────────────┴─────────────┴────────────┴───────┐    │ │
│  │  │                    Zustand Stores                      │    │ │
│  │  │  (library, reader, bookmark, search, auth, sync...)   │    │ │
│  │  └───────────────────────────────────────────────────────┘    │ │
│  │        │                    │                     │            │ │
│  │  ┌─────┴──────┐    ┌───────┴───────┐    ┌───────┴───────┐    │ │
│  │  │   Dexie    │    │  Web Worker   │    │    Axios      │    │ │
│  │  │ (IndexedDB)│    │   (Search)    │    │  (API Client) │    │ │
│  │  └────────────┘    └───────────────┘    └───────┬───────┘    │ │
│  └─────────────────────────────────────────────────│─────────────┘ │
│                                                     │               │
│  ┌──────────────────────────────────────────────────│──────────────┐│
│  │                    apps/server (Spring Boot)     │              ││
│  │  ┌───────────────────────────────────────────────┴────────────┐││
│  │  │                     REST API Layer                          │││
│  │  │  AuthController   BookController   ProgressController      │││
│  │  │  (含书签API /bookmarks)                                    │││
│  │  └────────────────────────────────────────────────────────────┘││
│  │        │                                                       ││
│  │  ┌─────┴───────────────────────────────────────────────────┐  ││
│  │  │                    Service Layer                         │  ││
│  │  │  AuthService   BookService   ProgressService            │  ││
│  │  └──────────────────────────────────────────────────────────┘  ││
│  │        │                                                       ││
│  │  ┌─────┴────────────┐    ┌─────────────────────────────────┐  ││
│  │  │  Spring Security │    │         JPA Repositories        │  ││
│  │  │  (JWT Auth)      │    │  UserRepo  BookRepo  ChapterRepo│  ││
│  │  └──────────────────┘    └────────────────┬────────────────┘  ││
│  │                                            │                   ││
│  │  ┌─────────────────────────────────────────┴────────────────┐ ││
│  │  │              PostgreSQL / H2 Database                     │ ││
│  │  │  users | books | chapters | reading_progress | bookmarks  │ ││
│  │  └───────────────────────────────────────────────────────────┘ ││
│  └────────────────────────────────────────────────────────────────┘│
│                                                                      │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │                      packages/core                              │ │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐                     │ │
│  │  │  Parser  │  │  Search  │  │  Types   │   Shared Modules    │ │
│  │  └──────────┘  └──────────┘  └──────────┘                     │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 核心设计决策

### 1. 全栈架构（前后端分离）

**决策**: 采用前后端分离的全栈架构

**架构**:
- **前端**: React SPA，独立部署
- **后端**: Spring Boot REST API
- **通信**: JWT Bearer Token 认证

**理由**:
- 离线优先：本地 IndexedDB 存储，无网络也能阅读
- 云端同步：登录后可多设备同步
- 灵活部署：前后端可独立扩展

### 2. 双模式存储策略

**决策**: 本地 + 云端双模式存储

| 场景 | 存储 | 说明 |
|------|------|------|
| 未登录 | IndexedDB | 纯本地，无需网络 |
| 已登录 | IndexedDB + PostgreSQL | 本地优先，后台同步 |

**理由**:
- 保证离线体验
- 登录后获得云端同步能力
- 本地缓存减少 API 请求

### 3. Monorepo 结构

**决策**: 使用 pnpm workspace

```
novel-reader/
├── apps/web          # React 前端
├── apps/server       # Spring Boot 后端
├── packages/core     # 共享核心逻辑
└── packages/shared   # 共享工具
```

**理由**:
- 统一管理前后端
- 核心逻辑（解析、搜索）可复用
- 依赖版本统一

### 4. 状态管理分层

| 数据类型 | 前端存储 | 后端存储 | 示例 |
|----------|----------|----------|------|
| UI 状态 | React useState | - | 弹窗开关 |
| 应用状态 | Zustand | - | 主题、阅读设置 |
| 持久化数据 | Dexie (IndexedDB) | PostgreSQL | 书籍、进度、书签 |
| 用户数据 | Zustand + localStorage | PostgreSQL | Token、用户信息 |

### 5. 大文件处理

**策略**:
- 文件解析：流式读取 + 编码转换
- 文本渲染：虚拟滚动（可选）
- 搜索：Web Worker 后台处理
- 上传：分块上传（后端支持 100MB）

---

## 数据流

### 离线模式（未登录）

```
用户导入文件
     │
     ▼
┌─────────────┐
│ File Reader │  读取文件为 ArrayBuffer
└─────────────┘
     │
     ▼
┌─────────────┐
│   Parser    │  编码检测 + 章节识别
│ (core)      │
└─────────────┘
     │
     ▼
┌─────────────┐
│   Dexie     │  存储书籍数据
│ (IndexedDB) │
└─────────────┘
     │
     ▼
┌─────────────┐
│   Zustand   │  状态管理
│  (Store)    │
└─────────────┘
     │
     ▼
┌─────────────┐
│    React    │  UI 渲染
│ Components  │
└─────────────┘
```

### 在线模式（已登录）

```
用户操作（如保存进度）
     │
     ▼
┌─────────────┐
│   Zustand   │  更新本地状态
│  (Store)    │
└─────────────┘
     │
     ├────────────────┐
     ▼                ▼
┌─────────────┐  ┌─────────────┐
│   Dexie     │  │   Axios     │  并行：本地 + 云端
│ (IndexedDB) │  │  (API Call) │
└─────────────┘  └─────────────┘
                       │
                       ▼
               ┌─────────────┐
               │Spring Boot  │  后端处理
               │   API       │
               └─────────────┘
                       │
                       ▼
               ┌─────────────┐
               │ PostgreSQL  │  持久化
               └─────────────┘
```

---

## 搜索架构

```
用户输入关键词
     │
     ▼
┌─────────────┐
│ SearchInput │  防抖处理（300ms）
└─────────────┘
     │
     ▼
┌─────────────┐
│ Main Thread │  发送消息到 Worker
└─────────────┘
     │
     ▼
┌─────────────┐
│ Web Worker  │  执行搜索（不阻塞 UI）
│ (Search)    │  支持 4 种模式
└─────────────┘
     │
     ▼
┌─────────────┐
│ SearchResult│  按章节分组结果
└─────────────┘
     │
     ▼
┌─────────────┐
│    React    │  渲染结果列表
│ Components  │
└─────────────┘
```

---

## 认证流程

```
用户登录/注册
     │
     ▼
┌─────────────┐
│   Axios     │  POST /api/auth/login
└─────────────┘
     │
     ▼
┌─────────────┐
│Spring Boot  │  验证凭据
│   API       │  生成 JWT (24h 有效)
└─────────────┘
     │
     ▼
┌─────────────┐
│  Auth Store │  存储 Token + 用户信息
│ (Zustand)   │  persist to localStorage
└─────────────┘
     │
     ▼
后续请求自动携带
Authorization: Bearer <token>
```

---

## 模块依赖

```
apps/web
    ├── packages/core (解析、搜索)
    ├── packages/shared (工具)
    └── → apps/server (API 调用)

apps/server
    └── 独立运行（无 JS 依赖）

packages/core
    └── packages/shared
```

---

## 技术选型理由

### 前端

| 技术 | 选择 | 理由 |
|------|------|------|
| 框架 | React 18 | 生态成熟，开发效率高 |
| 构建 | Vite 5 | 开发体验好，热更新快 |
| 样式 | Tailwind CSS v3 | 快速开发，一致性好 |
| 动画 | Framer Motion | React 动画首选 |
| UI 组件 | Radix UI | 无样式可定制，可访问性好 |
| 状态 | Zustand | 轻量简单，持久化方便 |
| 存储 | Dexie 4 | IndexedDB 最佳封装 |
| HTTP | Axios | 拦截器强大，错误处理好 |

### 后端

| 技术 | 选择 | 理由 |
|------|------|------|
| 框架 | Spring Boot 3 | Java 生态成熟，企业级 |
| 语言 | Java 21 | LTS 版本，虚拟线程 |
| 安全 | Spring Security + JWT | 标准方案，无状态认证 |
| ORM | Spring Data JPA | 开发效率高 |
| 数据库 | PostgreSQL | 开源，功能强大 |
| 迁移 | Flyway | 版本控制数据库变更 |

---

## 相关文档

- [技术栈详情](./tech-stack.md)
- [ADR 索引](./adr/README.md)
- [后端 API 文档](../development/backend/api.md)
- [数据库设计](../development/backend/database.md)
