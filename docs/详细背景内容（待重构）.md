# Novel Reader 项目完整背景

## 项目概述

这是一个**本地小说阅读器**项目，采用 Monorepo 架构，当前阶段为纯前端实现，预留后端扩展能力。

### 核心功能目标

1. **文件解析**
    - 支持 TXT（含 GBK/UTF-8/GB18030/Big5 等多种编码自动检测）
    - 支持 EPUB（使用 epub.js）
    - 可选支持 PDF（使用 pdf.js）

2. **强大的全局搜索**（这是最重要的核心功能）
    - 全文关键词搜索
    - 搜索结果按章节分组统计
    - 显示匹配上下文
    - 高亮跳转到具体位置
    - **核心用例**：只看某个角色/人物出现的所有章节
    - 使用 Web Worker 避免 UI 阻塞

3. **阅读体验**
    - 字体设置（字体、大小、行高、字间距）
    - 主题切换（白天/夜间/护眼等多种模式）
    - 阅读进度自动记忆
    - 书签功能

4. **本地书架**
    - 文件导入管理
    - 书籍列表展示
    - 使用 IndexedDB 持久化存储

### UI 目标

精美、现代、动画丝滑、交互流畅、视觉高级

---

## 技术决策

### 架构

- **Monorepo 结构**：使用 pnpm workspace
- **当前阶段**：纯前端
- **后端预留**：`apps/server` 目录预留，未来可加 Spring Boot / Node.js / FastAPI

### 为什么纯前端足够

| 文件大小 | JS 处理能力 | 说明 |
|----------|-------------|------|
| < 10MB | 几百毫秒 | 流畅 |
| 10-50MB | 1-3 秒 | 可接受，用 Web Worker |
| > 100MB | 需要优化 | 分片加载 |

99% 的小说文件在 50MB 以内，纯前端 + Web Worker 完全够用。

### 技术栈

| 类别 | 技术 | 说明 |
|------|------|------|
| 框架 | React 18 + Vite | 快速开发 |
| 语言 | JavaScript | 不用 TypeScript |
| 样式 | Tailwind CSS v3 | 稳定版，支持暗色模式 |
| 动画 | Framer Motion | 丝滑动画效果 |
| 图标 | Lucide React | 现代简洁 |
| UI 组件 | Radix UI | 无样式可定制 |
| 样式工具 | clsx + tailwind-merge | class 合并 |
| 状态管理 | Zustand | 轻量 |
| 本地存储 | Dexie (IndexedDB) | 存书籍和进度 |
| 后台任务 | Web Worker | 搜索不阻塞 UI |

---

## 已完成的工作

### Step 1: Monorepo 基础结构 ✅

已创建目录结构：

```
novel-reader/
├── apps/
│   ├── web/                    # React 前端
│   └── server/                 # 后端预留
├── packages/
│   ├── core/                   # 核心逻辑（前后端共享）
│   │   └── src/
│   │       ├── parser/         # 文件解析
│   │       ├── search/         # 搜索算法
│   │       └── types/          # 类型定义
│   └── shared/                 # 共享工具
│       └── src/
│           ├── constants/      # 常量
│           └── utils/          # 工具函数
├── package.json
├── pnpm-workspace.yaml
├── .gitignore
└── README.md
```

### Step 2: Vite + React + 依赖配置 ✅

`apps/web` 已初始化完成：

**已安装的依赖：**
- react, react-dom
- vite, @vitejs/plugin-react
- tailwindcss@3, postcss, autoprefixer
- clsx, tailwind-merge
- framer-motion
- lucide-react
- @radix-ui/react-dialog, dropdown-menu, scroll-area, slider, switch, tabs, tooltip
- zustand
- dexie
- @types/react, @types/react-dom

**已配置：**
- Tailwind CSS（含暗色模式 `darkMode: 'class'`）
- 路径别名：`@/` → `src/`，`@core/` → `packages/core/src`，`@shared/` → `packages/shared/src`
- 自定义滚动条样式
- 基础 App.jsx 占位

**前端目录结构：**
```
apps/web/src/
├── main.jsx
├── App.jsx
├── index.css
├── components/
│   ├── ui/           # 基础 UI 组件
│   ├── reader/       # 阅读器组件
│   ├── search/       # 搜索组件
│   └── bookshelf/    # 书架组件
├── hooks/
├── stores/           # Zustand 状态
├── workers/          # Web Workers
├── utils/
├── styles/
└── lib/
```

**启动命令：**
```bash
cd novel-reader
pnpm install
pnpm dev
# 访问 http://localhost:5173
```

---

## 后续开发路线图

### Step 3: 核心解析模块 - `packages/core`

在 `packages/core/src/parser/` 中实现：

1. **编码检测** (`encoding.js`)
    - 使用 jschardet 或类似库
    - 支持 UTF-8, GBK, GB18030, GB2312, Big5 自动检测
    - 提供手动指定编码的能力

2. **TXT 解析器** (`txt-parser.js`)
    - 读取文件为 ArrayBuffer
    - 检测并转换编码
    - 返回纯文本内容

3. **章节识别** (`chapter-detector.js`)
    - 正则匹配常见章节格式：
        - `第X章`、`第X节`、`Chapter X`
        - `第一章`、`第二章`（中文数字）
        - `【第X章】`、`（第X章）`
        - 自定义正则支持
    - 返回章节列表：`[{ title, startIndex, endIndex }]`

4. **统一数据结构** (`types/book.js`)
   ```javascript
   // Book 结构
   {
     id: string,
     title: string,
     content: string,        // 全文内容
     chapters: [
       { 
         index: number,
         title: string,
         start: number,      // 字符起始位置
         end: number         // 字符结束位置
       }
     ],
     metadata: {
       encoding: string,
       fileSize: number,
       totalChapters: number,
       totalCharacters: number
     }
   }
   ```

**需要安装的依赖（在 packages/core）：**
- jschardet（编码检测）

---

### Step 4: 基础布局 + 主题系统

1. **整体布局框架**
    - 响应式布局
    - 侧边栏（书架/目录）
    - 主内容区（阅读器）
    - 顶部工具栏

2. **主题系统**
    - 白天模式（亮色背景）
    - 夜间模式（深色背景）
    - 护眼模式（米黄/豆绿背景）
    - 主题切换动画（Framer Motion）
    - 使用 Zustand 存储主题偏好
    - 使用 localStorage 持久化

3. **基础 UI 组件封装**
    - Button
    - Modal (基于 Radix Dialog)
    - Dropdown (基于 Radix)
    - Switch
    - Slider

---

### Step 5: 书架页面

1. **文件导入**
    - 拖拽上传
    - 点击选择文件
    - 支持多文件批量导入
    - 文件类型校验

2. **书籍列表**
    - 卡片/列表视图切换
    - 显示书名、阅读进度、最后阅读时间
    - 封面占位图

3. **IndexedDB 存储** (Dexie)
    - 书籍信息表
    - 阅读进度表
    - 书签表

4. **书籍管理**
    - 删除书籍
    - 重新导入（覆盖）

---

### Step 6: 阅读器页面

1. **文本渲染**
    - 虚拟滚动（大文件性能优化）
    - 分页/滚动模式切换

2. **章节导航**
    - 目录侧边栏
    - 快速跳转
    - 上一章/下一章

3. **字体设置面板**
    - 字体选择（预置 + 系统字体）
    - 字号调节 (Slider)
    - 行高调节
    - 字间距调节
    - 边距调节
    - 实时预览

4. **进度管理**
    - 自动记录阅读位置
    - 进度百分比显示
    - 跳转到指定位置/章节

---

### Step 7: 全局搜索（核心功能）

1. **搜索 Worker** (`workers/search.worker.js`)
    - 接收全文内容和关键词
    - 后台执行搜索，不阻塞 UI
    - 支持普通文本和正则表达式

2. **搜索结果结构**
   ```javascript
   {
     keyword: string,
     totalMatches: number,
     chapters: [
       {
         chapterIndex: number,
         chapterTitle: string,
         matchCount: number,
         matches: [
           {
             position: number,      // 全文位置
             context: string,       // 前后文（如前后各50字）
             highlightStart: number,
             highlightEnd: number
           }
         ]
       }
     ]
   }
   ```

3. **搜索 UI**
    - 搜索输入框（支持正则切换）
    - 搜索历史
    - 结果按章节折叠展示
    - 每章匹配数量显示
    - 点击跳转到具体位置
    - 高亮显示关键词

4. **性能优化**
    - 防抖搜索
    - 取消进行中的搜索
    - 大结果集分页加载

---

## 开发原则

1. **组件设计**：高内聚、低耦合，组件职责单一
2. **状态管理**：全局状态用 Zustand，组件状态用 useState
3. **样式规范**：优先使用 Tailwind，复杂样式抽取为组件
4. **性能意识**：大数据用虚拟滚动，耗时任务用 Web Worker
5. **代码复用**：核心逻辑放 `packages/core`，可被前后端共用

---

## 当前状态

✅ Step 1: Monorepo 结构 - 完成
✅ Step 2: Vite + React + 依赖 - 完成
⏳ Step 3: 核心解析模块 - 待开发

**下一步**：实现 `packages/core` 的 TXT 解析功能，包括编码检测和章节识别。

---

## 继续开发

你可以从 Step 3 开始，告诉我你想要开发哪个部分，或者有任何问题都可以讨论。